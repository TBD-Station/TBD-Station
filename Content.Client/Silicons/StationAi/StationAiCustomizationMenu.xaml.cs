using Content.Client.UserInterface.Controls;
using Content.Shared.Silicons.StationAi;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;
using System.Linq;
using System.Numerics;

namespace Content.Client.Silicons.StationAi;

[GenerateTypedNameReferences]
public sealed partial class StationAiCustomizationMenu : FancyWindow
{
    [Dependency] private readonly IEntityManager _entManager = default!;
    [Dependency] private readonly IPrototypeManager _protoManager = default!;

    private readonly SharedStationAiSystem _stationAiSystem = default!;

    private EntityUid? _owner = null;
    private StationAiCustomizationGroupContainer _coreContainer;
    private StationAiCustomizationGroupContainer _hologramContainer;

    public event Action<ProtoId<StationAiCustomizationPrototype>, StationAiCustomizationType>? SendStationAiCustomizationMessageAction;

    public StationAiCustomizationMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _stationAiSystem = _entManager.System<SharedStationAiSystem>();

        Title = Loc.GetString("station-ai-customization-menu");

        var prototypes = _protoManager.EnumeratePrototypes<StationAiCustomizationPrototype>();
        var corePrototypes = new List<StationAiCustomizationPrototype>();
        var hologramPrototypes = new List<StationAiCustomizationPrototype>();

        foreach (var prototype in prototypes)
        {
            switch (prototype.Category)
            {
                case StationAiCustomizationType.Core:
                    corePrototypes.Add(prototype);
                    break;

                case StationAiCustomizationType.Hologram:
                    hologramPrototypes.Add(prototype);
                    break;
            }
        }

        corePrototypes = corePrototypes.OrderBy(x => x.Name).ToList();
        hologramPrototypes = hologramPrototypes.OrderBy(x => x.Name).ToList();

        _coreContainer = new StationAiCustomizationGroupContainer(corePrototypes, StationAiCustomizationType.Core, StationAiState.Occupied.ToString());
        CustomizationGroupsContainer.AddTab(_coreContainer, Loc.GetString("station-ai-customization-core"));

        _hologramContainer = new StationAiCustomizationGroupContainer(hologramPrototypes, StationAiCustomizationType.Hologram, StationAiCustomizationType.Hologram.ToString());
        CustomizationGroupsContainer.AddTab(_hologramContainer, Loc.GetString("station-ai-customization-hologram"));
    }

    public void SetOwner(EntityUid owner)
    {
        _owner = owner;
        UpdateState();
    }

    public void UpdateState()
    {
        if (_owner == null || !_entManager.TryGetComponent<StationAiCoreComponent>(_owner, out var stationAiCore))
            return;

        if (!_stationAiSystem.TryGetInsertedAI((_owner.Value, stationAiCore), out var insertedAi))
            return;

        if (!_entManager.TryGetComponent<StationAiCustomizationComponent>(insertedAi, out var stationAiCustomization))
            return;

        foreach (var child in _coreContainer.Children)
        {
            if (child is not StationAiCustomizationEntryContainer entry)
                continue;

            entry.SelectButton.Pressed = (entry.Prototype.ID == stationAiCustomization.StationAiCoreLayerData?.Id);
        }

        foreach (var child in _hologramContainer.Children)
        {
            if (child is not StationAiCustomizationEntryContainer entry)
                continue;

            entry.SelectButton.Pressed = (entry.Prototype.ID == stationAiCustomization.StationAiHologramLayerData?.Id);
        }
    }

    public void OnSendStationAiCustomizationMessage(ProtoId<StationAiCustomizationPrototype> prototype, StationAiCustomizationType category)
    {
        SendStationAiCustomizationMessageAction?.Invoke(prototype, category);
    }

    private sealed class StationAiCustomizationGroupContainer : BoxContainer
    {
        public StationAiCustomizationGroupContainer(List<StationAiCustomizationPrototype> prototypes, StationAiCustomizationType category, string key)
        {
            Orientation = LayoutOrientation.Vertical;
            HorizontalExpand = true;
            VerticalExpand = true;

            foreach (var prototype in prototypes)
            {
                var rsiPath = prototype.LayerData[key].RsiPath;
                var rsiState = prototype.LayerData[key].State;

                var entry = new StationAiCustomizationEntryContainer(prototype, category, rsiPath, rsiState);
                AddChild(entry);
            }
        }
    }

    private sealed class StationAiCustomizationEntryContainer : BoxContainer
    {
        public StationAiCustomizationPrototype Prototype;
        public Button SelectButton;

        public StationAiCustomizationEntryContainer(StationAiCustomizationPrototype prototype, StationAiCustomizationType category, string? rsiPath, string? rsiState)
        {
            Prototype = prototype;

            Orientation = LayoutOrientation.Horizontal;
            HorizontalExpand = true;

            SelectButton = new Button
            {
                Text = Loc.GetString(prototype.Name),
                HorizontalExpand = true,
                ToggleMode = true
            };

            SelectButton.OnPressed += args =>
            {
                SelectButton.Pressed = true;

                if (this.Parent == null)
                    return;

                foreach (var child in this.Parent.Children)
                {
                    if (child is not StationAiCustomizationEntryContainer entry)
                        continue;

                    if (entry == this)
                        continue;

                    entry.SelectButton.Pressed = false;
                }

                var parent = this.Parent;

                while (parent != null && parent is not StationAiCustomizationMenu)
                    parent = parent.Parent;

                (parent as StationAiCustomizationMenu)?.OnSendStationAiCustomizationMessage(prototype, category);
            };

            AddChild(SelectButton);

            var icon = new AnimatedTextureRect
            {
                HorizontalAlignment = HAlignment.Center,
                VerticalAlignment = VAlignment.Center,
                SetWidth = 56,
                SetHeight = 56,
                Margin = new Thickness(10f, 2f)
            };

            if (rsiPath != null && rsiState != null)
            {
                var specifier = new SpriteSpecifier.Rsi(new ResPath(rsiPath), rsiState);
                icon.SetFromSpriteSpecifier(specifier);
            }

            icon.DisplayRect.TextureScale = new Vector2(2f, 2f);

            AddChild(icon);
        }
    }
}


